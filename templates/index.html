<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha Médica</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="app-page">
    <div class="container">
        <div class="top-bar">
            <h1>Ficha de Evolução do Paciente</h1>
            <a href="{{ url_for('logout') }}" class="logout-link">Sair</a>
        </div>

        <form id="ficha-form" method="post" action="/generate_doc">

            <div class="section">
                <h2>Dados do Paciente</h2>

                <div class="form-group">
                    <label>Nome:</label>
                    <input type="text" name="nome" required>
                </div>

                <div class="form-group">
                    <label>Nº:</label>
                    <input type="text" name="numero">
                </div>

                <div class="form-group">
                    <label>Data Nascimento:</label>
                    <input type="date" name="data_nascimento">
                </div>

                <div class="form-group">
                    <label>Idade:</label>
                    <input type="number" name="idade">
                </div>

                <div class="form-group">
                    <label>Sexo:</label>
                    <select name="sexo">
                        <option value="">Selecione</option>
                        <option>Masculino</option>
                        <option>Feminino</option>
                        <option>Outro</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Est. Civil:</label>
                    <input type="text" name="estado_civil">
                </div>

                <div class="form-group">
                    <label>Ocupação:</label>
                    <input type="text" name="ocupacao">
                </div>

                <div class="form-group">
                    <label>Nome Pai:</label>
                    <input type="text" name="nome_pai">
                </div>

                <div class="form-group">
                    <label>Nome Mãe:</label>
                    <input type="text" name="nome_mae">
                </div>

                <div class="form-group">
                    <label>Endereço Permanente:</label>
                    <input type="text" name="endereco_permanente">
                </div>

                <div class="form-group">
                    <label>Endereço Temporário:</label>
                    <input type="text" name="endereco_temporario">
                </div>

                <div class="form-group">
                    <label>Cartão SUS:</label>
                    <input type="text" name="cartao_sus">
                </div>
            </div>

            <div class="section">
                <h2>Evolução</h2>

                <div class="form-group">
                    <label>Data do Atendimento:</label>
                    <input type="date" name="data_atendimento" required>
                </div>

                <div class="form-group">
                    <label>Nova Evolução:</label>
                    <textarea id="nova_evolucao" rows="4" placeholder="Digite a evolução médica e de enfermagem"></textarea>
                    <button type="button" id="add_evolucao_btn" class="secondary-btn">Adicionar evolução</button>
                </div>

                <div id="lista_evolucoes"></div>

                <!-- campo oculto com todas as evoluções concatenadas -->
                <textarea id="evolucao" name="evolucao" hidden></textarea>
            </div>

            <button type="submit">Gerar Ficha</button>
        </form>
    </div>

    <script>
        const novaEvolucaoInput = document.getElementById("nova_evolucao");
        const addEvolucaoBtn = document.getElementById("add_evolucao_btn");
        const listaEvolucoes = document.getElementById("lista_evolucoes");
        const evolucaoHidden = document.getElementById("evolucao");

        function atualizarCampoHidden() {
            const textos = [...document.querySelectorAll(".evolucao-text")]
                .map(t => t.value.trim())
                .filter(t => t.length > 0);

            evolucaoHidden.value = textos.join("\\n\\n");
        }

        function criarItemEvolucao(texto) {
            const item = document.createElement("div");
            item.className = "evolucao-item";

            const label = document.createElement("span");
            label.className = "evolucao-label";
            label.textContent = "Evolução:";

            const textarea = document.createElement("textarea");
            textarea.className = "evolucao-text";
            textarea.rows = 4;
            textarea.value = texto;
            textarea.disabled = true; // só edita depois de clicar em Editar

            const btnEditar = document.createElement("button");
            btnEditar.type = "button";
            btnEditar.textContent = "Editar";
            btnEditar.className = "edit-btn";

            btnEditar.addEventListener("click", () => {
                textarea.disabled = !textarea.disabled;
                btnEditar.textContent = textarea.disabled ? "Editar" : "Salvar";

                if (textarea.disabled) {
                    atualizarCampoHidden();
                }
            });

            const btnRemover = document.createElement("button");
            btnRemover.type = "button";
            btnRemover.textContent = "Remover";
            btnRemover.className = "danger-btn";

            btnRemover.addEventListener("click", () => {
                item.remove();
                atualizarCampoHidden();
            });

            const actions = document.createElement("div");
            actions.className = "evolucao-actions";
            actions.appendChild(btnEditar);
            actions.appendChild(btnRemover);

            item.appendChild(label);
            item.appendChild(textarea);
            item.appendChild(actions);

            return item;
        }

        addEvolucaoBtn.addEventListener("click", () => {
            const texto = novaEvolucaoInput.value.trim();
            if (!texto) return;

            listaEvolucoes.appendChild(criarItemEvolucao(texto));
            novaEvolucaoInput.value = "";
            atualizarCampoHidden();
        });

        const fichaForm = document.getElementById("ficha-form");
        fichaForm.addEventListener("submit", (event) => {
            if (document.querySelectorAll(".evolucao-text").length === 0 &&
                novaEvolucaoInput.value.trim().length > 0) {
                const item = criarItemEvolucao(novaEvolucaoInput.value.trim());
                listaEvolucoes.appendChild(item);
                novaEvolucaoInput.value = "";
            }

            atualizarCampoHidden();

            if (!evolucaoHidden.value.trim()) {
                alert("Adicione pelo menos uma evolução antes de gerar a ficha.");
                event.preventDefault();
            }
        });
    </script>
</body>
</html>
